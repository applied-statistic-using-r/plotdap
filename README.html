<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Carson Sievert" />

<meta name="date" content="2017-06-08" />

<title></title>

<script src="README_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="README_files/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="README_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="README_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="README_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="README_files/navigation-1.1/tabsets.js"></script>
<link href="README_files/highlightjs-1.1/default.css" rel="stylesheet" />
<script src="README_files/highlightjs-1.1/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>



<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="fluid-row" id="header">




</div>


<div id="plotdap" class="section level1">
<h1>plotdap</h1>
<p>The R package <strong>plotdap</strong> makes it easy to visualize ‘tabledap’ and ‘griddap’ objects obtained via the <a href="https://github.com/ropensci/rerddap"><strong>rerddap</strong></a> package.</p>
<div id="installation" class="section level2">
<h2>Installation</h2>
<p><strong>plotdap</strong> isn’t (yet) on CRAN, but you can install the development version with:</p>
<pre class="r"><code>devtools::install_github(&#39;ropensci/plotdap&#39;)</code></pre>
</div>
<div id="getting-started-with-plotdap" class="section level2">
<h2>Getting started with <code>plotdap()</code></h2>
<p>The <code>plotdap()</code> function makes it easy to visualize data acquired via <code>tabledap()</code> or <code>griddap()</code>. Regardless of the data you want to visualize, you’ll always want to start a plot via <code>plotdap()</code>, where you may specify some “global” plotting options. Subsequent sections will demonstrate how to add tables/grids via <code>add_tabledap()</code>/<code>add_griddap()</code>, but for now we’ll focus on options provided by <code>plotdap()</code>. Most importantly, the first argument decides whether <a href="https://stat.ethz.ch/R-manual/R-devel/library/graphics/html/plot.html">base</a> or <a href="https://cran.r-project.org/package=ggplot2">ggplot2</a> graphics should be used for the actual plotting.</p>
<pre class="r"><code>library(plotdap)
plotdap()
plotdap(&quot;base&quot;)</code></pre>
<p><img src="README_files/figure-html/world-1.png" /><img src="README_files/figure-html/world-2.png" /></p>
<p>In addition to choosing a plotting method, <code>plotdap()</code> is where you can define properties of the background map, including the target projection using a valid coordinate reference system (CRS) defintion. Projection is performed using the <a href="http://proj4.org/">PROJ.4 library</a>, and <a href="http://www.spatialreference.org">spatialreference.org</a> is a great resource for finding PROJ.4 CRS descriptions. Using the search utility, you can for example, <a href="http://spatialreference.org/ref/sr-org/?search=South+Pole&amp;srtext=Search">search for “South Pole”</a> and pick from a number of options. Here I’ve chosen the <a href="http://spatialreference.org/ref/sr-org/8375/">MODIS South Pole Stereographic</a> option and copy-pasted the <a href="http://spatialreference.org/ref/sr-org/8375/proj4/">Proj4 page</a> with the CRS definition:</p>
<pre class="r"><code>plotdap(&quot;base&quot;,
  mapTitle = &quot;MODIS South Pole Stereographic&quot;, 
  mapFill = &quot;transparent&quot;, 
  mapColor = &quot;steelblue&quot;,
  crs = &quot;+proj=stere +lat_0=-90 +lat_ts=-90 +lon_0=-63 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs&quot;
)</code></pre>
<p><img src="README_files/figure-html/southPole-1.png" style="display: block; margin: auto;" /></p>
<p>You might notice that some projections aren’t “well-defined” on a global scale, and thus, may result in an error, or a “broken” looking map. For instance, <a href="http://spatialreference.org/ref/epsg/3467/">this Albers projection centered on Alaska</a>:</p>
<pre class="r"><code>alaska &lt;- &quot;+proj=aea +lat_1=55 +lat_2=65 +lat_0=50 +lon_0=-154 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs&quot;
plotdap(&quot;base&quot;, crs = alaska)</code></pre>
<pre class="r"><code>#&gt; Error code: 6
#&gt; Error in CPL_transform(x, crs$proj4string, crs$epsg) : OGR error</code></pre>
<p>That does not mean we can’t use this (or similar) projections – we just have to be careful that they are sensible given the lat/lon limits. By default, those limits span the entire world, but as we’ll see later, the limits are shrunk to the given data (i.e., <code>griddap()</code> / <code>tabledap()</code>) limits. In other words, we should expect this projection to work once we “add” some data located near Alaska to the visualization. However, in case you want to make a map without any data, or want to customize the background map in some special way, you can supply an <a href="https://CRAN.R-project.org/package=sf"><strong>sf</strong></a> object (or something coercable to an <strong>sf</strong> object) to the <code>mapData</code> argument.</p>
<pre class="r"><code>library(sf)
library(mapdata)
w &lt;- st_as_sf(maps::map(&quot;world&quot;, plot = FALSE, fill = TRUE))
us &lt;- st_transform(subset(w, ID == &quot;USA&quot;), alaska)
plotdap(mapData = us)</code></pre>
<p><img src="README_files/figure-html/unnamed-chunk-2-1.png" style="display: block; margin: auto;" /></p>
<p>With the odd exception of window sizing and projections, the options in <code>plotdap()</code> should <em>just work</em> in a similar way for either plotting method. However, there are some useful options that are deliberately left out, since they work differently based on the plotting method.</p>
<p>Since the result of <code>plotdap()</code> is always a map, it always forces a fixed aspect ratio (i.e., <span class="math inline">\(\frac{height}{width}\)</span> of graph equals <span class="math inline">\(r=\frac{latitude}{longitude}\)</span>). For this reason, the current size of your graphics device may not be sensible for the value of <span class="math inline">\(r\)</span> (for instance, if <span class="math inline">\(r\)</span> is high, but the height of the graphics device is small, you may see an error such as: <code>polygon edge not found</code> since the device cannot possibly render the result under the conditions). For a number of reasons, <code>plotdap()</code> will not automatically resize your graphics device; instead, it’s recommended that you use a reliable graphics device such as Cairo, and use a height/width ratio close to <span class="math inline">\(r\)</span>.</p>
<pre class="r"><code># write plot to disk using the Cairo package
library(Cairo)
# (latitude limits) / (longitude limits)
r &lt;- 85 / 120
CairoPNG(&quot;myPlot.png&quot;, height = 400 * r, width = 400, res = 96)
# alter default margins for base plotting (leaving just enough space for a title)
par(mar = c(0, 0, 1, 0))
plotdap(&quot;base&quot;, mapData = us, mapTitle = &quot;Albers projection of Alaska&quot;)
dev.off()
#&gt; quartz_off_screen 
#&gt;                 2</code></pre>
<p><img src="README_files/figure-html/unnamed-chunk-3-1.png" style="display: block; margin: auto;" /></p>
<p>More advanced users that know some base/ggplot2 plotting may want more control of certain aspects of the plot (a later section – Customizing <code>plotdap()</code> objects – covers this topic).</p>
</div>
<div id="adding-tabledap-layers" class="section level2">
<h2>Adding <code>tabledap()</code> layers</h2>
<p>The <code>add_tabledap()</code> function allows you to add markers that encode variable(s) obtained via <code>tabledap()</code> to an existing <code>plotdap()</code> object. For example, suppose we have the following <code>sardines</code> data, and wish to understand the frequency of subsample counts:</p>
<pre class="r"><code>sardines &lt;- tabledap(
  &#39;FRDCPSTrawlLHHaulCatch&#39;,
  fields = c(&#39;latitude&#39;,  &#39;longitude&#39;, &#39;time&#39;, &#39;scientific_name&#39;, &#39;subsample_count&#39;),
  &#39;time&gt;=2010-01-01&#39;, &#39;time&lt;=2012-01-01&#39;, &#39;scientific_name=&quot;Sardinops sagax&quot;&#39;
)
sardines
#&gt; &lt;ERDDAP tabledap&gt; FRDCPSTrawlLHHaulCatch
#&gt;    Path: [/Users/cpsievert/Library/Caches/R/rerddap/8cb244e059b86865b7933a3d9b72fe16.csv]
#&gt;    Last updated: [2017-06-08 10:41:14]
#&gt;    File size:    [0 mb]
#&gt; # A tibble: 56 x 5
#&gt;    latitude longitude                 time scientific_name subsample_count
#&gt;  *    &lt;chr&gt;     &lt;chr&gt;                &lt;chr&gt;           &lt;chr&gt;           &lt;int&gt;
#&gt;  1  38.1945   -124.07 2010-04-16T03:36:00Z Sardinops sagax              50
#&gt;  2   37.609 -123.6561 2010-04-18T02:54:00Z Sardinops sagax              38
#&gt;  3  37.4188 -123.3463 2010-04-18T10:48:00Z Sardinops sagax               1
#&gt;  4   36.984 -123.3326 2010-04-19T03:27:00Z Sardinops sagax              50
#&gt;  5  36.8118 -123.6868 2010-04-19T06:42:00Z Sardinops sagax              50
#&gt;  6  36.7333 -123.8675 2010-04-19T09:55:00Z Sardinops sagax              50
#&gt;  7   35.922 -124.7985 2010-04-20T07:21:00Z Sardinops sagax              39
#&gt;  8   36.992 -123.7716 2010-04-27T02:56:00Z Sardinops sagax               2
#&gt;  9  36.9725 -124.1091 2010-04-27T07:02:00Z Sardinops sagax               9
#&gt; 10  36.9925 -124.3968 2010-04-27T10:04:00Z Sardinops sagax              50
#&gt; # ... with 46 more rows</code></pre>
<p>At the very least, <code>add_tabledap()</code> needs a base map (i.e., a <code>plotdap()</code> object), the <code>tabledap()</code> data, and a <em>formula</em> defining the variable of interest (for encoding the color of the markers). In R, you can create a formula by prefixing <code>~</code> to some expression. This formula can simply reference a variable already residing in the dataset (e.g., <code>~subsample_count</code>) or it can be a function of some variables (e.g. <code>~log2(subsample_count)</code>):</p>
<pre class="r"><code>add_tabledap(
  plotdap(), 
  sardines, 
  ~subsample_count
)
add_tabledap(
  plotdap(crs = &quot;+proj=robin&quot;, mapTitle = &quot;Log subsample count&quot;), 
  sardines, 
  ~log2(subsample_count)
)</code></pre>
<p><img src="README_files/figure-html/unnamed-chunk-5-1.png" /><img src="README_files/figure-html/unnamed-chunk-5-2.png" /></p>
<p>Since <code>time</code> is an important variable in many <code>tabledap()</code> objects, <code>add_tabledap()</code> also has a <code>animate</code> argument which allows you to easily animate over the <code>time</code> variable. It is also easy to alter the color scale and symbol type via the <code>color</code> and <code>shape</code> arguments. For details about these arguments, please refer to the documentation on <code>help(add_tabledap)</code></p>
<pre class="r"><code>add_tabledap(
  plotdap(crs = &quot;+proj=robin&quot;), 
  sardines, 
  ~subsample_count, 
  color = &quot;density&quot;, 
  shape = 4, 
  animate = TRUE
)</code></pre>
<div align="center">
<p><a href="http://i.imgur.com/87KAnsS"> <img src = "http://i.imgur.com/87KAnsS.gif" height = "500" width = "700" /> </a></p>
</div>
</div>
<div id="adding-griddap-layers" class="section level2">
<h2>Adding <code>griddap()</code> layers</h2>
<p>Similar to <code>add_tabledap()</code>, the <code>add_griddap()</code> function makes it easy to add rasters (i.e., rectangular tiles) to a <code>plotdap()</code> object. To demonstrate, lets obtain some of the latest sea surface temperatures along the western coast of the US.</p>
<pre class="r"><code>murSST &lt;- griddap(
  &#39;jplMURSST41&#39;, latitude = c(22, 51), longitude = c(-140, -105),
  time = c(&#39;last&#39;, &#39;last&#39;), fields = &#39;analysed_sst&#39;
)
murSST
#&gt; &lt;ERDDAP griddap&gt; jplMURSST41
#&gt;    Path: [/Users/cpsievert/Library/Caches/R/rerddap/5d5022a6daf4b9e7957e864f84600bbf.nc]
#&gt;    Last updated: [2017-06-08 10:57:49]
#&gt;    File size:    [81.28 mb]
#&gt;    Dimensions (dims/vars):   [3 X 1]
#&gt;    Dim names: time, latitude, longitude
#&gt;    Variable names: Analysed Sea Surface Temperature
#&gt;    data.frame (rows/columns):   [10156401 X 4]
#&gt; # A tibble: 10,156,401 x 4
#&gt;                    time   lat     lon analysed_sst
#&gt;                   &lt;chr&gt; &lt;dbl&gt;   &lt;dbl&gt;        &lt;dbl&gt;
#&gt;  1 2017-06-06T09:00:00Z    22 -140.00       23.667
#&gt;  2 2017-06-06T09:00:00Z    22 -139.99       23.675
#&gt;  3 2017-06-06T09:00:00Z    22 -139.98       23.676
#&gt;  4 2017-06-06T09:00:00Z    22 -139.97       23.674
#&gt;  5 2017-06-06T09:00:00Z    22 -139.96       23.670
#&gt;  6 2017-06-06T09:00:00Z    22 -139.95       23.670
#&gt;  7 2017-06-06T09:00:00Z    22 -139.94       23.677
#&gt;  8 2017-06-06T09:00:00Z    22 -139.93       23.688
#&gt;  9 2017-06-06T09:00:00Z    22 -139.92       23.701
#&gt; 10 2017-06-06T09:00:00Z    22 -139.91       23.714
#&gt; # ... with 10,156,391 more rows</code></pre>
<p>Again, similar to <code>add_tabledap()</code>, <code>add_griddap()</code> needs a base map (i.e., a <code>plotdap()</code> object), the <code>griddap()</code> data, and a <em>formula</em> defining the variable of interest (for encoding the fill of the rectangles). The <code>add_griddap()</code> function also has a <code>maxpixels</code> argument which sets a maximum threshold for the number of cells (i.e., pixels) to use before projection and plotting occurs. Compared to ggplot2, base plotting is much more efficient at rendering raster objects, so it might be worth increasing the threshold in that case:</p>
<pre class="r"><code># reduce the number of trailing digits in the legend
options(digits = 2)
# remove plotting margins
par(mar = c(0, 0, 0, 0))
add_griddap(
  plotdap(&quot;base&quot;, crs = &quot;+proj=robin&quot;), 
  murSST, ~analysed_sst, maxpixels = 50000
)</code></pre>
<p><img src="README_files/figure-html/unnamed-chunk-8-1.png" style="display: block; margin: auto;" /></p>
<p>The <code>murSST</code> grid has a single time point (i.e., <code>length(unique(murSST$data$time)) == 1</code>), but what do we do when there are multiple time points? In addition to animating multiple grids (a la <code>add_tabledap()</code>), you also have the option to summarize multiple grids into a single grid. To demonstrate, lets grab some wind speeds measured along the west coast of the US.</p>
<pre class="r"><code>wind &lt;- griddap(
  &#39;erdQMwindmday&#39;, time = c(&#39;2016-11-16&#39;, &#39;2017-01-16&#39;),
  latitude = c(30, 50), longitude = c(210, 240),
  fields = &#39;x_wind&#39;
)
unique(wind$data$time)
#&gt; [1] &quot;2016-11-16T00:00:00Z&quot; &quot;2016-12-16T00:00:00Z&quot; &quot;2017-01-16T00:00:00Z&quot;</code></pre>
<p>When faced with multiple time periods, and <code>animate = FALSE</code> (the default), the <code>time</code> argument is used to reduce multiple grids (i.e., raster bricks) to a single grid (i.e., a single raster layer). You can pass any R function to the <code>time</code> argument, but when <code>animate = FALSE</code>, you should take care to ensure the function returns a single value. The default uses the <code>mean()</code> function so that each cell represents the average (in this case amongst three time points), but we could easily set this to <code>var()</code> to get the variance for each cell:</p>
<pre class="r"><code># add space for a title
par(mar = c(0, 0, 1, 0))
add_griddap(
  plotdap(&quot;base&quot;, crs = alaska, mapTitle = &quot;Mean wind speed&quot;), 
  wind, ~x_wind
)
add_griddap(
  plotdap(&quot;base&quot;, crs = alaska, mapTitle = &quot;Variance of wind speed&quot;), 
  wind, ~x_wind, time = var
)</code></pre>
<p><img src="README_files/figure-html/unnamed-chunk-10-1.png" /><img src="README_files/figure-html/unnamed-chunk-10-2.png" /></p>
<p>If you just want to animate the raw grid values over time (instead of computing summary statistic(s) for each cell), you can set <code>time</code> to the <code>identity</code> function, then set <code>animate = TRUE</code>:</p>
<pre class="r"><code>add_griddap(
  plotdap(crs = &quot;+proj=robin&quot;), 
  wind, ~x_wind, 
  time = identity, 
  animate = TRUE
)</code></pre>
<div align="center">
<p><a href="http://i.imgur.com/aev0aZt"> <img src = "http://i.imgur.com/aev0aZt.gif" height = "500" width = "700" /> </a></p>
</div>
</div>
<div id="combining-tablesgrids" class="section level2">
<h2>Combining tables/grids</h2>
<p>The <code>plotdap()</code> interface is designed so that you can plot both tables and grids at once (although I don’t recommend trying to plot more than one <code>griddap()</code> or <code>tabledap()</code> object at once). It’s also designed to work well with the <code>%&gt;%</code> operator from the <strong>magrittr</strong> package so that code can be expressed in a left-to-right (rather than inside-out) fashion:</p>
<pre class="r"><code>plotdap(&quot;base&quot;) %&gt;%
  add_griddap(murSST, ~analysed_sst) %&gt;%
  add_tabledap(sardines, ~subsample_count)</code></pre>
<p><img src="README_files/figure-html/unnamed-chunk-12-1.png" style="display: block; margin: auto;" /></p>
</div>
<div id="modifying-ggplotdap-objects" class="section level2">
<h2>Modifying <code>ggplotdap</code> objects</h2>
<p>By this point, you might have noticed some subtle differences in the defaults of <code>plotdap(&quot;ggplot2&quot;)</code> versus <code>plotdap(&quot;base&quot;)</code>. The default base version is left intentially minimal as it is often much harder (or impossible) to modify/remove elements from a base graphic once it’s drawn. However, this is fairly easy using the <strong>ggplot2</strong> approach (assuming you know a bit of <strong>ggplot2</strong>), thanks to the <code>add_ggplot()</code> function (think of it like the <code>+</code> operator in <strong>ggplot2</strong>).</p>
<pre class="r"><code>library(ggplot2)
plotdap(crs = &quot;+proj=robin&quot;) %&gt;%
  add_tabledap(sardines, ~subsample_count, size = 1) %&gt;%
  add_ggplot(
    labs(
      subtitle = &quot;Sardinops sagax samples&quot;,
      caption = &quot;Sardines are yummy&quot;
    ), 
    theme_minimal(),
    theme(axis.ticks = element_blank(), axis.text = element_blank())
  )</code></pre>
<p><img src="README_files/figure-html/unnamed-chunk-13-1.png" style="display: block; margin: auto;" /></p>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
